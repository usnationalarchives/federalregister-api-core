<% feed_autodiscovery entries_url(:format => :rss) %>

<% title "Entries for #{@publication_date.to_formatted_s(:pretty)}" %>
<h1 class="title"><span><%= @publication_date %> Issue</span></h1>

<%= render :partial => "statistics_by_date", :locals => {:issue => @issue, :label => @publication_date, :other_dates => false, :url => entries_by_date_path(@publication_date)} %>

<div id="content_area">

<% @agencies.each do |agency| %>
  <div class="title_bar">
    <h2 id="<%= agency.slug %>"><%= link_to agency.name, agency_path(agency) %></h2>
    <a href="#entries" class="back_to_top">Back to Top</a>
  </div>
  
  <% sub_agencies_on_this_page = @agencies & agency.children %>
  <% if sub_agencies_on_this_page.present? %>
    <ul>
      <% sub_agencies_on_this_page.each do |sub_agency| %>
        <li><span class="see">See</span> <%= link_to sub_agency.name, '#' + sub_agency.slug %> <span class="count_pill"><%= sub_agency.entries.to_a.size %></span></li>
      <% end %>
    </ul>
  <% end %>
  
  <% agency.entries_excluding_subagency_entries.group_by(&:entry_type).each do |type, entries_by_type| %>
    <h3><%= type.pluralize %></h3>
    <dl>
    <% entries_by_type.group_by(&:toc_subject).each do |toc_subject, entries_by_toc_subject| %>
      <% if toc_subject.present? %>
        <dt><%= toc_subject %></dt>
        <% entries_by_toc_subject.sort_by{|e| e.toc_doc || ''}.each do |entry| %>
        <dd>
          <%= render :partial => 'entry_with_page_and_frdoc', :locals => {:entry => entry, :entry_title => entry.toc_doc || entry.title } %>
        </dd>
        <% end %>
      <% else %>
        <% entries_by_toc_subject.sort_by(&:title).each do |entry| %>
        <dt>
          <%= render :partial => 'entry_with_page_and_frdoc', :locals => {:entry => entry, :entry_title => entry.toc_doc || entry.title } %>
        </dt>
        <% end %>
      <% end %>
    <% end %>
    </dl>
  <% end %>
<% end %>


<% if @entries_without_agency.present? %>
  <div class="title_bar">
    <h2>Other Articles</h2>
  </div>
  <% @entries_without_agency.group_by(&:agency_names).each do |agency_names, entries| %>
    <h3><%= agency_names.map(&:name).to_sentence %></h3>
    <dl>
    <% entries.each do |entry| %>
      <dt><%= render :partial => 'entry_with_page_and_frdoc', :locals => {:entry => entry, :entry_title => entry.title } %></dt>
    <% end %>
    </dl>
  <% end %>
<% end %>

</div> <!-- END CONTENT AREA -->



<%# TODO HELP-DESIGN move this to the top of the markup and then pull it over %>
<% aside_tag(:id => 'sidebar') do %>
  
  <% section_tag(:id => 'date_chooser') do %>
    <div id="calendar_wrapper">
      <%= render :esi => entries_by_month_path(@publication_date, :current_date => @publication_date.to_s(:iso)) %>
    </div>
    
    <% form_tag entries_date_search_path, :method => :get, :id => "date_selector" do %>
      <label>Go to a specific date:</label>
      <%= text_field_tag :search, '', :placeholder => 'MM/DD/YYYY' %>
      <%= submit_tag 'Go' %>
    <% end %>
  <% end -%>
  
  <% section_tag(:id => 'meta_toc') do %>
    <div class="TOC aside_box">
      <% if @publication_date > Date.parse('1995-01-01') %>
      <div class="download_separator">
        <%= link_to 'Download PDF', issue_pdf_url(@publication_date), :class => 'button format list pdf' %>        
      </div>
      <% end %>
      <ul>
        <% @agencies.each do |agency| %>
          <li>
            <a href="#<%= agency.slug %>"><%= agency.name %></a> 
            <span class="count_pill"><%= agency.entries.to_a.size %></span>
          </li>
        <% end -%>
      </ul>
    </div>    
  <% end -%>
  
  <p><%= link_to 'Subscribe', entries_url(:format => :rss), :class => 'rss' %></p>
  
<% end -%>


<% if false %>
  
  <% if @map.present? %>
    <h3>Locations Mentioned</h3>
    <% add_javascript { @map.to_js } %>
    <div id="map" class='small_map'></div>
  <% end %>
  
  <h3>Today's Article Types</h3>
  <%= render :partial => 'entries/charts/by_type', :locals => {:entries => @entries} %>
  
  <h3>Top Agencies Reporting</h3>
  <%= render :partial => 'entries/charts/by_agency', :locals => {:agencies => @agencies, :entry_count => @entries.count} %>
<% end %>
