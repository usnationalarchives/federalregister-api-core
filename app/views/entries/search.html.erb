<% title @search.term.blank? ? 'Search Articles' : "Search Results for '#{h @search.term}'" %>

<h1 class="title"><span><%= @search.term.blank? ? 'Search Articles' : "Search Results for '#{h @search.term}'" %></span></h1>

<% unless @search.valid? %>
<ul class="errors">
  <% @search.errors.each do |err| %>
  <li><%= err %></li>
  <% end %>
</ul>
<% end %>

<%= render :partial => "search/tabs", :locals => {:search => @search, :selected => :entries}%>
<div class="search_bar">
  
  <% form_for :conditions, @search, :url => entries_search_path, :html => {:method => :get} do |f| %>
    <label>Find</label>
    <%= f.text_field :term %>
    <%= f.submit 'Search' %>
  <% end %>
  
  <div class="actions">
    <%= link_to 'Subscribe', params.merge(:format => :rss, :order => 'date', :publication_date_less_than => nil), :class => 'button notext rss' %>
    <% feed_autodiscovery url_for(params.merge(:format => :rss, :order => 'date', :publication_date_less_than => nil)) %>
    <%= link_to 'Widget', widget_instructions_path(params.except(:action, :controller)), :class => 'button widget spawn_modal notext', :id => 'widget' %>
  </div>
  
</div>

<% unless @search.blank? %>

  <div class="filters">
    <h4>Date</h4>
    <ul>
      <%= render :partial => "search/facet", :collection => @search.date_facets %>
    
      <%# TODO HELP-RUBY i know this doesn't go here. just wanted to stash it somewhere  %>
      <!-- <li><%#= sparkline(:data => @search.date_distribution.to_a.sort_by{|date, count| date}.map{|date, count| count}, :alt => "Monthly Distribution" ) %></li> -->      
    </ul>
    
    <% form_for :conditions, @search, :url => entries_search_path, :html => {:method => :get} do |f| %>
    <h4>Near</h4>
    <ul>
      <li>
        <% params[:conditions].except(:location, :within).keys.each do |attr| %>
          <%= f.hidden_field attr, :id => '' %>
        <% end %>
        <%= f.text_field :location, :placeholder =>  "Zip Code", :class => 'zip' %>
        <%= f.select :within, %w(5 10 25 50 100 200).map{|n| ["#{n} miles", n]} %>
        <%= f.submit 'Go' %>
      </li>
    </ul>
    <% end %>
    
    <%= render :partial => "search/facets", :locals => {:facets => @search.type_facets,     :name => "Type"    }%>
    <%= render :partial => "search/facets", :locals => {:facets => @search.section_facets,  :name => "Section" }%>
    <%= render :partial => "search/facets", :locals => {:facets => @search.agency_facets,   :name => "Agency"  }%>
    <%= render :partial => "search/facets", :locals => {:facets => @search.topic_facets,    :name => "Topic"   }%>
  </div>

  <div class="result_set">
    <%= render :partial => "search/filters", :locals => {:search => @search} %>
    
    <% if @search.results.present? %>
      <div class="search_info titlebar">
        <div class="article_count">
          <h2 class="title_bar"><span class="small_stack">Articles <span>Found</span></span><%= number_with_delimiter @search.results.total_entries %></h2>
        </div>

        <ul class="ordering">
          <% EntrySearch::SUPPORTED_ORDERS.each do |order| %>
            <li class="<%= 'on' if @search.order == order.downcase %>">
              <%= link_to order, params.merge(:order => order.downcase), :class => '' %>
            </li>
          <% end %>
        </ul>
      </div>
    
      <ol class="results">
        <%= render :partial => 'result', :collection => @search.results, :as => :entry %>
      </ol>
      <%= will_paginate @search.results %>
    <% else %>
      <p>No articles were found.</p>
    <% end %>
  </div>
<% end %>