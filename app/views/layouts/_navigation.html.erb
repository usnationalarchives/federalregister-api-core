<% nav_tag(:id => "navigation") do %>

  <ul class="container">
    <li id='nav-home'><a href="/" class="home" title="Home">Home</a></li>
    <li class="dropdown previewable nav_sections">
      <a class="sections top_nav">Sections<span class="arrow"></span></a>
      <div class="subnav">
        <ul class="left_column">
          <% Section.all.each do |section| %>
            <li id='<%= section.slug %>'><%= link_to section.title, section_path(section), :class => "#{section.slug}" %></li>
          <% end %>
        </ul>
        <ul class="right_column">
          <% Section.all.each do |section| %>
            <li id='<%= section.slug %>-preview' class="preview">
              <% @highlighted_entries = section.highlighted_entries(IssueApproval.latest_publication_date).with_lede_photo.limit(1) %>
              <% if @highlighted_entries.present? %>
                <%= render :partial => 'sections/carousel', :locals => {:entries => @highlighted_entries} %>
              <% end %>
              <div class="suggested_searches">
                <% section.canned_searches.active.in_order.limit(4).in_groups_of(2,false).each_with_index do |searches, index| %>
                  <div class="row <%= index == 0 ? 'first' : '' %>">
                    <% searches.each do |canned_search| %>
                        <div class="info suggested_search"> 
                          <h1>
                            <%= link_to canned_search.title, canned_search_path(canned_search) %>
                            <span class="result_count"><%= canned_search.search.count_in_last_n_days(365) %> in the last year</span>
                          </h1>
                         </div>
                      <% end %>
                  </div> <!-- .row -->
                <% end %>
              </div> <!-- .suggested_searches -->

              <div class="daily_stats">
                <ul>
                  <li class="new_articles">
                    <% conditions = {:publication_date => {:is => Issue.current.publication_date}, :section_ids => [section.id]} %>
                    <% link_to entries_search_path(:conditions => conditions, :utm_source => 'navigation', :utm_medium => 'dropdown', :utm_content => 'new_articles') do %>
                      <span class="count"><%= count = EntrySearch.new(:conditions => conditions).count %></span>
                      <span class="details"><%= pluralize_without_count(count, 'New Articles') %> In this Issue</span>
                    <% end %>
                  </li>
                  <li class="closing_soon">
                    <% conditions = {:comment_date => {:gte => Date.current, :lte => 1.week.from_now.to_date}, :section_ids => [section.id]} %>
                    <% link_to entries_search_path(:conditions => conditions, :utm_source => 'homepage', :utm_medium => 'slideshow', :utm_content => 'comments_closing') do %>
                      <span class="count"><%= count = EntrySearch.new(:conditions => conditions).count %></span>
                      <span class="details"><%= pluralize_without_count(count, 'Comment Period') %> Ending Soon</span> 
                    <% end %>
                  </li>
                </ul>
              </div> <!-- .daily_stats -->
            </li>
          <% end %>
        </ul>
      </div>
    </li>
    <li class="dropdown previewable nav_browse">
      <a class="browse top_nav">Browse<span class="arrow"></span></a>
      <div class="subnav browse_list">
        <ul class="left_column">
          <li id='agencies-browse'>
            <%= link_to 'Agencies', agencies_path, :class => "agencies" %>
          </li>
          <li id='topics-browse'>
            <%= link_to 'Topics', topics_path, :class => "topics" %>
          </li>
          <li id='current-article-browse'>
            <%= link_to 'Dates', entries_current_issue_path, :class => "date" %>
          </li>
          <li id='public-inspection-browse'>
            <%= link_to 'Public Inspection', public_inspection_documents_path, :class => "public_inspection" %>
          </li>
          <li id='executive-orders-browse'>
            <%= link_to 'Executive Orders', executive_orders_path, :class => "executive_orders" %>
          </li>
        </ul>
        <ul class="right_column">
          <li id="agencies-browse-preview" class="preview">
            <div class="agency_finder">
              <h2>Go to a specific agency</h2>
              <% form_tag entries_date_search_path, :method => :get, :id => "date_selector" do %>
                <label>Go to a specific agency:</label>
                <input id="agency-search" class="browse_search" placeholder="Agricultural Marketing Service" data-autocomplete="autocomplete" />
              <% end %>
            </div>
            <div class="agency_browse">
              <table class="cabinet_agencies default">
                <thead>
                  <tr>
                    <th><h2>Browse Agencies</h2></th>
                    <th class="past_7_days" data-tooltip="Articles Published in the Last 7 Days"></th>
                    <th class="recently_opened" data-tooltip="Articles with Comment Periods Opened in the Last 14 Days"></th>
                    <th class="closing_soon" data-tooltip="Articles with Comment Periods Closing in the Next 7 Days"></th>
                  </tr>
                </thead>
                <tbody>
                  <% Agency.in_navigation.each_with_index do |agency, index| %>
                    <tr>
                      <td class="agency_name"><%= link_to agency.name, agency_path(agency) %></td>
                      <% count = agency.entry_counts_since('week') %>
                      <td class="count_7_days">
                        <% conditions = {:publication_date => {:gte => Issue.current.publication_date - 1.week}, :agency_ids => [agency.id]} %>
                        <%= link_to count, entries_search_path(:conditions => conditions, :utm_source => 'navigation', :utm_medium => 'dropdown', :utm_content => 'agencies_last_7') %>
                      </td>
                      <% conditions = {:publication_date => {:gte => Issue.current.publication_date - 2.weeks}, :comment_date => {:gte => Date.current} , :agency_ids => [agency.id]} %>
                      <% count = EntrySearch.new(:conditions => conditions).count %>
                      <td class="comments_recently_opened">
                        <%= link_to count, entries_search_path(:conditions => conditions, :utm_source => 'navigation', :utm_medium => 'dropdown', :utm_content => 'agencies_opened_recently') %>
                      </td>
                      <% conditions = {:comment_date => {:gte => Date.current, :lte => 1.week.from_now.to_date}, :agency_ids => [agency.id]} %>
                      <% count = EntrySearch.new(:conditions => conditions).count %>
                      <td class="comments_closing_soon">
                        <%= link_to count, entries_search_path(:conditions => conditions, :utm_source => 'navigation', :utm_medium => 'dropdown', :utm_content => 'agencies_closing_soon') %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </li>
          <li id="topics-browse-preview" class="preview">
            <div class="topic_finder">
              <h2>Go to a Specific Topic</h2>
              <% form_tag entries_date_search_path, :method => :get, :id => "date_selector" do %>
                <label>Go to a specific topic:</label>
                <input id="topic-search" class="browse_search" placeholder="Antidumping" data-autocomplete="autocomplete" />
              <% end %>
            </div>
            <div class="topic_browse">
              <table class="recent_topics default">
                <thead>
                  <tr>
                    <th><h2>Browse Topics</h2></th>
                    <th class="past_7_days" data-tooltip="Related Articles Published in the Last 7 Days"></th>
                    <th class="recently_opened" data-tooltip="Related Articles with Comment Periods Opened in the Last 14 Days"></th>
                    <th class="closing_soon" data-tooltip="Related Articles with Comment Periods Closing in the Next 7 Days"></th>
                  </tr>
                </thead>
                <tbody>
                  <% Topic.without_routine.top_by_article_count(10).in_last_days(30).each do |topic| %>
                    <tr>
                      <td class="topic_name">
                        <%= link_to topic.name, topic_path(topic) %>
                      </td>
                      <td class="count_7_days">
                        <%= topic.entries_count %>
                      </td>
                      <% conditions = {:publication_date => {:gte => Issue.current.publication_date - 2.weeks}, :comment_date => {:gte => Date.current} , :topic_ids => [topic.id]} %>
                      <% count = EntrySearch.new(:conditions => conditions).count %>
                      <td class="comments_recently_opened">
                        <%= link_to count, entries_search_path(:conditions => conditions, :utm_source => 'navigation', :utm_medium => 'dropdown', :utm_content => 'topics_opened_recently') %>
                      </td>
                      <% conditions = {:comment_date => {:gte => Date.current, :lte => 1.week.from_now.to_date}, :topic_ids => [topic.id]} %>
                      <% count = EntrySearch.new(:conditions => conditions).count %>
                      <td class="comments_closing_soon">
                        <%= link_to count, entries_search_path(:conditions => conditions, :utm_source => 'navigation', :utm_medium => 'dropdown', :utm_content => 'topics_closing_soon') %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </li>
          <li id="current-article-browse-preview" class="preview">
            <div class="fr_stats">
              <% issue = Issue.current %>
              <h2>
                Current Issue
                <% if issue.total_pages && issue.total_pages > 1 %>
                  <span class="page_count"><%= issue.total_pages %> Pages</span>
                <% end %>
              </h2>  
              <ul class="current_issue statistics">
                <% if issue.notice_count == 0 && issue.proposed_rule_count == 0 && issue.rule_count == 0 && issue.presidential_documents_count == 0 && issue.significant_entries_count == 0 && issue.total_pages == 1 %>
                  <li>No statistics available.</li>
                <% else %>
                  <% if issue.notice_count > 0 %>
                    <li><%= link_to "<span>#{issue.notice_count}</span> #{pluralize_without_count issue.notice_count, "Notice"}", entries_search_path(:conditions => {:type => "NOTICE", :publication_date => {:is => issue.publication_date}}) %></li>
                  <% end %>
                  <% if issue.proposed_rule_count > 0 %>
                    <li><%= link_to "<span>#{issue.proposed_rule_count}</span> #{pluralize_without_count issue.proposed_rule_count, "Proposed Rule"}", entries_search_path(:conditions => {:type => "PRORULE", :publication_date => {:is => issue.publication_date}}) %></li>
                  <% end %>            
                  <% if issue.rule_count > 0 %>
                    <li><%= link_to "<span>#{issue.rule_count}</span> #{pluralize_without_count issue.rule_count, "Rule"}", entries_search_path(:conditions => {:type => "RULE", :publication_date => {:is => issue.publication_date}}) %></li>
                  <% end %>            
                  <% if issue.presidential_documents_count > 0 %>
                    <li><%= link_to "<span>#{issue.presidential_documents_count}</span> #{pluralize_without_count issue.presidential_documents_count, "Presidential Document"}", entries_search_path(:conditions => {:type => "PRESDOCU", :publication_date => {:is => issue.publication_date}}) %></li>
                  <% end -%>
                  <% if issue.significant_entries_count > 0 %>
                    <li><%= link_to "<span>#{issue.significant_entries_count}</span> #{pluralize_without_count issue.significant_entries_count, "Significant Document"}", entries_search_path(:conditions => {:significant => 1, :publication_date => {:is => issue.publication_date}}) %></li>
                  <% end %>
                <% end %>
              </ul>
            </div>
            <div class="calendar_holder">
              <h2>Explore</h2>
              <div id="date_chooser">
                <div id="calendar_wrapper" class="cal_double">
                  <%= render :esi => entries_by_month_path(Issue.current.publication_date - 1.month, :table_class => 'no_select cal_first') %>
                  <%= render :esi => entries_by_month_path(Issue.current.publication_date, :current_date => Issue.current.publication_date.to_s(:iso), :table_class => 'no_select cal_last') %>
                </div>
              </div>
            </div>
            <div class="date_input_holder">
              <h2>Go to a specific date</h2>
              <% form_tag entries_date_search_path, :method => :get, :id => "date_selector" do %>
                <label>Go to a specific date:</label>
                <%= text_field_tag :search, '', :placeholder => 'MM/DD/YYYY', :class => "browse_search" %>
                <%= submit_tag 'Go' %>
              <% end %>
            </div>
          </li>
          <li id="executive-orders-browse-preview" class="preview">
            <ol>
              <% orders_by_president_and_year = ExecutiveOrderPresenter.all_by_president_and_year %>
              <% orders_by_president_and_year.each do |president, eo_collections| %>
                <li class="pres_holder" id="<%=president.identifier%>">
                  <div class='photo'></div>
                  <div class="pres_details">
                    <h2><%= president.full_name %></h2>
                    <% if president == orders_by_president_and_year.first.first %> 
                    <ol class="recent">
                      <% eo_collections.first.executive_orders[0..2].each do |executive_order| %>
                        <li class="executive_order_wrapper">
                          <span class="eo_number">EO <%= executive_order.executive_order_number %>:</span>
                          <%= link_to executive_order.title, entry_path(executive_order) %>
                        </li>
                      <% end %>
                    </ol>
                    <% end %>
                    <ol class="children">
                      <% eo_collections.reverse.each do |eo_collection| %>
                        <li class="<%= cycle('left', 'right') %>">
                          <%= eo_collection.year %>
                          <%= link_to eo_collection.count, executive_orders_by_president_and_year_path(president.identifier, eo_collection.year) %>:
                        </li>
                      <% end %>
                    </ol>
                  </div>
                </li>
              <% end %>
            </ol>
          </li>
        </ul>
      </div>
    </li>
    <li class="dropdown nav_search">
      <a class="search top_nav">Search<span class="arrow"></span></a>
      <ul class="subnav search_list">
        <li id='articles-search'>
          <%= link_to 'Article Search', entries_search_path, :class => "article-search" %>
        </li>
        <li id='articles-adv-search'>
          <%= link_to 'Advanced Article Search', entries_search_path(:anchor => 'advanced'), :class => "advanced-search" %>
        </li>
        <li id='events-search'>
          <%= link_to 'Events Search', events_search_path, :class => "events-search" %>
        </li>
        <li id='regulations-search'>
          <%= link_to 'Unified Agenda Search', regulatory_plans_search_path, :class => "unified-agenda-search" %>
        </li>
        <li id='public-inspection-search'>
          <%= link_to 'Public Inspection Search', public_inspection_search_path, :class => "public-inspection-search" %>
        </li>
      </ul>
    </li>
    <%= render :esi => '/layout/navigation_page_list' %>

    <li class="nav_blog" id='nav-blog'><a href="/blog" class="blog top_nav">Blog</a></li>

    <esi:include src="/my/special/navigation" />

    <li class="inline_search">
      <form action="<%= entries_search_path %>" method="get" class="search_form">
        <label for="term">Search the Federal Register</label>
        <%= text_field_tag "conditions[term]", nil, :id => "term", :title => 'Search Articles', :placeholder =>  "Search Articles" %>
        <%= submit_tag 'Go', :class => "search_btn", :title => 'Search' %>
      </form>
    </li>
  </ul>

<% end -%>

